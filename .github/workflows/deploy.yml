name: Deploy Docker Compose

on:
  push:
    branches:
      - staging
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Choose environment
      - name: Set target environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "host=${{ secrets.STAGING_HOST }}" >> $GITHUB_OUTPUT
            echo "compose_file=docker-compose.staging.yml" >> $GITHUB_OUTPUT
            echo "env_name=Staging" >> $GITHUB_OUTPUT
          else
            echo "host=${{ secrets.PROD_HOST }}" >> $GITHUB_OUTPUT
            echo "compose_file=docker-compose.prod.yml" >> $GITHUB_OUTPUT
            echo "env_name=Production" >> $GITHUB_OUTPUT
          fi

      # Fixed SSH key installation (this is the important fix)
      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}           # ← correct name
          known_hosts: unnecessary                     # ← we add it manually below

      # Add droplet to known_hosts (prevents host verification prompt)
      - name: Add droplet to known_hosts
        run: ssh-keyscan -H ${{ steps.env.outputs.host }} >> ~/.ssh/known_hosts

      # Copy files
      - name: Copy compose files and .env
        run: |
          scp docker-compose.yml \
              docker-compose.staging.yml \
              docker-compose.prod.yml \
              .env \
              ${{ secrets.SSH_USER }}@${{ steps.env.outputs.host }}:/home/${{ secrets.SSH_USER }}/myapp/

      # Deploy
      - name: Deploy to ${{ steps.env.outputs.env_name }}
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ steps.env.outputs.host }} << EOF
            cd /home/${{ secrets.SSH_USER }}/myapp

            docker compose pull
            docker compose -f docker-compose.yml -f ${{ steps.env.outputs.compose_file }} up -d --remove-orphans
            docker image prune -f

            echo "Deployed to ${{ steps.env.outputs.env_name }} at $(date)"
          EOF