name: CI/CD Deploy (Basic)

on:
  push:
    branches:
      - staging
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for full git history

      # 2️⃣ Set up Python for pytest
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      # 4️⃣ Run pytest
      - name: Run tests
        run: |
          echo "Running pytest..."
          python -m pytest tests || { echo "❌ Pytest failed"; exit 1; }

      # 5️⃣ Run Spectral lint
      - name: Run Spectral
        run: |
          echo "Running Spectral lint..."
          docker run --rm -v "$PWD:/work" -w /work \
            stoplight/spectral:latest lint \
            --ruleset /work/.spectral.yaml \
            /work/openapi.yaml || { echo "❌ Spectral lint failed"; exit 1; }

      # 6️⃣ Start SSH agent
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DROPLET_SSH_KEY }}

      # 7️⃣ Determine which script to run
      - name: Set deployment variables
        id: vars
        run: |
          BRANCH="${GITHUB_REF##*/}"
          if [ "$BRANCH" = "staging" ]; then
            echo "HOST=${{ secrets.STAGING_DROPLET_HOST }}" >> $GITHUB_OUTPUT
            echo "SCRIPT=setup-docker.sh" >> $GITHUB_OUTPUT
          elif [ "$BRANCH" = "main" ]; then
            echo "HOST=${{ secrets.PROD_DROPLET_HOST }}" >> $GITHUB_OUTPUT
            echo "SCRIPT=setup_prod.sh" >> $GITHUB_OUTPUT
          else
            echo "Branch $BRANCH not deployable. Exiting."
            exit 0
          fi

      # 8️⃣ Deploy via SSH
      - name: Run deploy script on droplet
        env:
          DROPLET_USER: ${{ secrets.DROPLET_USER }}
          HOST: ${{ steps.vars.outputs.HOST }}
          SCRIPT: ${{ steps.vars.outputs.SCRIPT }}
          REMOTE_PATH: /root/ifrs9pro_backend
        run: |
          echo "Deploying $SCRIPT to $HOST"
          ssh -o StrictHostKeyChecking=no $DROPLET_USER@$HOST "REMOTE_PATH='$REMOTE_PATH' SCRIPT='$SCRIPT' bash -s" << 'EOF'
            set -euo pipefail
            cd "$REMOTE_PATH" || { echo "Remote path not found: $REMOTE_PATH"; exit 1; }
            chmod +x "$SCRIPT" || true
            echo "Running $SCRIPT..."
            ./"$SCRIPT"
            echo "✅ Deployment completed successfully."
          EOF
