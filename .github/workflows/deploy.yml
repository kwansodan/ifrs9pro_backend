name: CI/CD Deploy (Docker Compose)

on:
  push:
    branches:
      - staging
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SECRET_KEY: "default-test-secret"

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest schemathesis

      # 4Ô∏è‚É£ Create fake site directory for tests 
      - name: Create fake site directory 
        run: | 
          mkdir -p site

      # 4Ô∏è‚É£ Run pytest
      - name: Run tests
        run: |
          echo "Running pytest..."
          python -m pytest tests || { echo "‚ùå Pytest failed"; exit 1; }

      # 5Ô∏è‚É£ Run Spectral
      - name: Run Spectral
        run: |
          echo "Running Spectral..."
          docker run --rm -v "$PWD:/work" -w /work \
            stoplight/spectral:latest lint \
            --ruleset /work/.spectral.yaml \
            /work/openapi.yaml || { echo "‚ùå Spectral lint failed"; exit 1; }

      # 6Ô∏è‚É£ Start Docker Compose stack
      - name: Start API stack (db + minio + fastapi)
        run: |
          echo "Starting docker-compose.local.yml..."
          docker compose -f docker-compose.local.yml up -d
          echo "Waiting 25 seconds for services to be healthy..."
          sleep 25

      # 7Ô∏è‚É£ Verify FastAPI is reachable
      - name: Check API health before testing
        run: |
          echo "Checking API at http://localhost:8000/health..."
          curl -f http://localhost:8000/health || { echo "‚ùå API is not healthy"; exit 1; }

      # 8Ô∏è‚É£ Schemathesis tests
      - name: Run Schemathesis API tests
        run: |
          echo "Running Schemathesis API tests..."
          PYTHONPATH=$(pwd) \
          schemathesis run http://localhost:8000/openapi.json \
            --wait-for-schema=20 \
            --checks not_a_server_error,status_code_conformance,content_type_conformance,response_schema_conformance,negative_data_rejection \
            || { echo "‚ùå Schemathesis tests failed"; exit 1; }

      # 9Ô∏è‚É£ Stop Docker Compose
      - name: Tear down API stack
        if: always()
        run: docker compose -f docker-compose.local.yml down

      # üîü SSH agent
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DROPLET_SSH_KEY }}

      # 1Ô∏è‚É£1Ô∏è‚É£ Determine deploy target
      - name: Set deployment variables
        id: vars
        run: |
          BRANCH="${GITHUB_REF##*/}"
          if [ "$BRANCH" = "staging" ]; then
            echo "HOST=${{ secrets.STAGING_DROPLET_HOST }}" >> $GITHUB_OUTPUT
            echo "SCRIPT=setup-docker.sh" >> $GITHUB_OUTPUT
          elif [ "$BRANCH" = "main" ]; then
            echo "HOST=${{ secrets.PROD_DROPLET_HOST }}" >> $GITHUB_OUTPUT
            echo "SCRIPT=setup_prod.sh" >> $GITHUB_OUTPUT
          fi

      # 1Ô∏è‚É£2Ô∏è‚É£ Deploy via SSH
      - name: Deploy to remote droplet
        env:
          DROPLET_USER: ${{ secrets.DROPLET_USER }}
          HOST: ${{ steps.vars.outputs.HOST }}
          SCRIPT: ${{ steps.vars.outputs.SCRIPT }}
          REMOTE_PATH: /root/ifrs9pro_backend
        run: |
          echo "Deploying $SCRIPT to $HOST"
          ssh -o StrictHostKeyChecking=no $DROPLET_USER@$HOST "REMOTE_PATH='$REMOTE_PATH' SCRIPT='$SCRIPT' bash -s" << 'EOF'
            set -euo pipefail
            cd "$REMOTE_PATH" || { echo "Remote path not found: $REMOTE_PATH"; exit 1; }
            chmod +x "$SCRIPT" || true
            ./"$SCRIPT"
            echo "‚úÖ Deployment completed successfully."
          EOF
